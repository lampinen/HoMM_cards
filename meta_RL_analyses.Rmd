---
title: "Meta RL analyses"
output: html_notebook
---

```{r}
library(tidyverse)
```

```{r}
num_runs = 10
results_dir = "results/paper_results/"

result_subdirs = c("nometa", "nometa_su_heldout", "nometa_random_holdout_longer", "nometa_only_one", 
                   "basic", "basic_su_heldout", "basic_random_holdout_longer", "basic_only_one")

new_game_strs = c("game_straight_flush_l_1_bv_0_sr_0",
                  "game_straight_flush_l_1_bv_1_sr_0",
                  "game_straight_flush_l_1_bv_0_sr_1",
                  "game_straight_flush_l_1_bv_1_sr_1")

new_game_strs_su_heldout = c("game_sum_under_l_1_bv_0_sr_0",
                             "game_sum_under_l_1_bv_1_sr_0",
                             "game_sum_under_l_1_bv_0_sr_1",
                             "game_sum_under_l_1_bv_1_sr_1")

new_game_strs_only_one = c('game_straight_flush_l_0_bv_1_sr_1', 'game_straight_flush_l_0_bv_1_sr_0', 'game_straight_flush_l_0_bv_0_sr_1', 'game_straight_flush_l_1_bv_0_sr_0', 'game_straight_flush_l_1_bv_1_sr_0', 'game_straight_flush_l_1_bv_0_sr_1', 'game_straight_flush_l_1_bv_1_sr_1')

new_game_strs_random_heldout = c('game_match_l_0_bv_0_sr_1', 'game_match_l_0_bv_1_sr_1', 'game_pairs_and_high_l_1_bv_1_sr_0', 'game_high_card_l_0_bv_1_sr_1', 'game_straight_flush_l_1_bv_0_sr_1', 'game_straight_flush_l_0_bv_0_sr_0', 'game_pairs_and_high_l_0_bv_1_sr_1', 'game_straight_flush_l_1_bv_0_sr_0', 'game_match_l_1_bv_0_sr_1', 'game_pairs_and_high_l_0_bv_1_sr_0', 'game_pairs_and_high_l_1_bv_0_sr_0', 'game_sum_under_l_1_bv_0_sr_0', 'game_sum_under_l_0_bv_1_sr_0', 'game_high_card_l_1_bv_0_sr_1', 'game_sum_under_l_0_bv_0_sr_0', 'game_pairs_and_high_l_0_bv_0_sr_1', 'game_sum_under_l_1_bv_0_sr_1', 'game_match_l_1_bv_1_sr_1', 'game_sum_under_l_0_bv_1_sr_1', 'game_straight_flush_l_1_bv_1_sr_1')


meta_mapping_tasks = c("toggle_losers", "toggle_black_valuable", "toggle_suits_rule")
meta_classification_tasks = c("is_losers", "is_black_valuable", "is_suits_rule",
                              "is_high_card", "is_match", "is_straight_flush", "is_pairs_and_high", "is_sum_under")
```

# utils

```{r}
load_d = function(results_dir, result_subdirs, num_runs, file_type) {
  d = data.frame()
  for (run_i in 0:(num_runs-1)) {
    for (result_subdir in result_subdirs) {
      filename = sprintf("%s%s/run%i_%s.csv", results_dir, result_subdir, run_i, file_type)
      if (!file.exists(filename)) {
        next
      }
      this_d = read.csv(filename, header=T) %>%
        mutate(run = run_i,
               run_type=result_subdir)
      d = bind_rows(d, this_d)
      }
  }
  return(d)
}
```


# meta-learning tests

```{r}
reward_d = load_d(results_dir, result_subdirs, num_runs, "new_rewards")

reward_d = reward_d %>%
  mutate(is_su_ho=grepl("su_heldout", run_type),
         is_only_one=grepl("only_one", run_type),
         is_random_ho=grepl("random", run_type),
         is_default=!(is_su_ho | is_random_ho | is_only_one)) %>%
  gather(game_str, reward, starts_with("game")) %>%
  mutate(game_type = str_extract(game_str, "high_card|match|straight_flush|pairs_and_high|sum_under"),
         losers = grepl("l_1", game_str),
         black_valuable = grepl("bv_1", game_str),
         suits_rule = grepl("sr_1", game_str),
         is_new_game = (is_default & game_str %in% new_game_strs) | (is_su_ho & game_str %in% new_game_strs_su_heldout) | (is_random_ho & game_str %in% new_game_strs_random_heldout) | (is_only_one & game_str %in% new_game_strs_only_one) )
```

```{r}
avg_reward_d = reward_d %>%
  select(-game_str) %>%
  filter(epoch == 0) %>%
  group_by(run_type, game_type, is_new_game) %>%
  summarize(avg_reward = mean(reward), sd_reward=sd(reward),
            se_reward = sd_reward/sqrt(n()), 
            ci_lo = avg_reward - 1.96*se_reward, 
            ci_hi = avg_reward + 1.96*se_reward)
```

```{r}
theme_set(theme_bw() + 
            theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()))
```

```{r}
ggplot(avg_reward_d, aes(x=game_type, fill=is_new_game, y=avg_reward)) +
  geom_bar(stat="identity", position="dodge") +
  geom_errorbar(aes(ymin=ci_lo, ymax=ci_hi), position="dodge") +
  scale_fill_brewer(palette="Set2") +
  facet_wrap(. ~ run_type)
```
```{r}
avg_reward_d %>% filter(is_new_game)
```

```{r}
ggplot(avg_reward_d %>% filter(is_new_game, run_type %in% c("basic", "nometa")), aes(x=run_type, fill=run_type, y=avg_reward)) +
  geom_bar(stat="identity", position="dodge") +
  geom_errorbar(aes(ymin=ci_lo, ymax=ci_hi), position="dodge", width=0.5) +
  scale_fill_brewer(palette="Set1")
```

## sweeping batch sizes
```{r}
sweep_d = load_d(results_dir, result_subdirs, num_runs, "new_sweep_rewards")

sweep_d = sweep_d %>%
  mutate(is_su_ho=grepl("su_heldout", run_type),
         is_only_one=grepl("only_one", run_type),
         is_random_ho=grepl("random", run_type),
         is_default=!(is_su_ho | is_random_ho | is_only_one)) %>%
  gather(game_str, reward, starts_with("game")) %>%
  mutate(game_type = str_extract(game_str, "high_card|match|straight_flush|pairs_and_high|sum_under"),
         losers = grepl("l_1", game_str),
         black_valuable = grepl("bv_1", game_str),
         suits_rule = grepl("sr_1", game_str),
         is_new_game = (is_default & game_str %in% new_game_strs) | (is_su_ho & game_str %in% new_game_strs_su_heldout) | (is_random_ho & game_str %in% new_game_strs_random_heldout) | (is_only_one & game_str %in% new_game_strs_only_one) )
```

```{r}
avg_sweep_d = sweep_d %>%
  select(-game_str) %>%
  filter(epoch == 0) %>%
  group_by(run_type, size, game_type, is_new_game) %>%
  summarize(avg_reward = mean(reward), sd_reward=sd(reward),
            se_reward = sd_reward/sqrt(n()), 
            ci_lo = avg_reward - 1.96*se_reward, 
            ci_hi = avg_reward + 1.96*se_reward)
```

```{r}
ggplot(avg_sweep_d, aes(x=size, color=is_new_game, y=avg_reward)) +
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin=ci_lo, ymax=ci_hi)) +
  scale_color_brewer(palette="Set2") +
  xlab("Meta Set Size") +
  facet_grid(game_type ~ run_type)
```

```{r}
ggplot(avg_sweep_d %>% filter(run_type %in% c("basic_only_one", "nometa_only_one")), aes(x=size, color=run_type, y=avg_reward)) +
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin=ci_lo, ymax=ci_hi)) +
  scale_color_brewer(palette="Set1") +
  xlab("Meta Set Size") +
  facet_grid(game_type ~ is_new_game)
```

# meta mapping (true) evaluation

```{r}
meta_d = load_d(results_dir, c("basic", "basic_su_heldout", "basic_random_holdout_longer", "basic_only_one"), num_runs, "new_meta_true_losses")

meta_d = meta_d %>%
  filter(epoch == 0) %>%
  mutate(is_su_ho=grepl("su_heldout", run_type),
         is_only_one=grepl("only_one", run_type),
         is_random_ho=grepl("random", run_type),
         is_default=!(is_su_ho | is_random_ho | is_only_one)) %>%
  gather(map_str, reward, -c(run, run_type, epoch), -starts_with("is_")) %>%
  separate(map_str, c("meta_task", "source", "target"), sep="[\\.]+") %>%
  mutate(is_new = (is_default & (source %in% new_game_strs | target %in% new_game_strs)) | (is_random_ho & (source %in% new_game_strs_random_heldout | target %in% new_game_strs_random_heldout)) | (is_only_one & (source %in% new_game_strs_only_one | target %in% new_game_strs_only_one)) | (is_su_ho & (source %in% new_game_strs_su_heldout | target %in% new_game_strs_su_heldout)))
```

```{r}
avg_meta_d = meta_d %>%
  group_by(run_type, run, meta_task, is_new) %>%
  summarize(avg_reward = mean(reward)) %>%
  group_by(run_type, meta_task, is_new) %>%
  summarize(avg_avg_reward = mean(avg_reward), sd_avg_reward = sd(avg_reward),
            se_reward = sd_avg_reward/sqrt(n()), 
            ci_lo = avg_avg_reward - 1.96*se_reward, 
            ci_hi = avg_avg_reward + 1.96*se_reward)
  
```

```{r}
ggplot(avg_meta_d, aes(x=meta_task, fill=is_new, y=avg_avg_reward)) +
  geom_bar(stat="identity", position="dodge") +
  geom_errorbar(aes(ymin=ci_lo, ymax=ci_hi), position="dodge") +
  scale_fill_brewer(palette="Set2") +
  facet_wrap(.~run_type)
```

# embeddings

```{r}
for (result_subdir in result_subdirs) {
  for (emb_type in c("guess", "final")) {
    emb_d = data.frame()
    for (run_i in 0:(num_runs-1)) {
      filename = sprintf("%s%s/run%i_%s_embeddings.csv", results_dir, result_subdir, run_i, emb_type)
      if (!file.exists(filename)) {
        next
      }
      this_d = read.csv(filename, header=T)
      this_d$run = run_i
      emb_d = bind_rows(emb_d, this_d)
    }
    
    pcs = prcomp(emb_d %>% select(-dimension, -run), center=T, scale=T)
    pc_d = data.frame(pcs$rotation)
    pc_d$task = row.names(pc_d)
    ggplot(pc_d, aes(x=PC1, y=PC2, color=task)) +
      geom_point() +
      geom_text(aes(label=task)) +
      guides(color=F)
    ggsave(sprintf("plots/%s_PCA_full_%s.png", result_subdir, emb_type), width=7, height=7)
  }
}
```

```{r}
# emb_type = "guess"
# emb_d = data.frame()
# for (meta_task in c("None", meta_mapping_tasks)) {
#   for (run_i in 0:(num_runs-1)) {
#     if (meta_task == "None") {
#       filename = sprintf("%srun%i_%s_embeddings.csv",results_dir, run_i, emb_type)
#       if (!file.exists(filename)) {
# #          print(paste("Skipping", filename, sep=" "))
#         next 
#       }
#       this_d = read.csv(filename, header=T)
#     } else {
#       filename = sprintf("%srun%i_%s_%s_embeddings.csv", results_dir, run_i, meta_task, emb_type)
#       if (!file.exists(filename)) {
# #          print(paste("Skipping", filename, sep=" "))
#         next 
#       }
#       this_d = read.csv(filename, header=T)
#     }
#     this_d$run = run_i
#     this_d$meta_task = meta_task
#     emb_d = bind_rows(emb_d, this_d)
#   }
# }
```
